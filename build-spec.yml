version: 0.2
env:
  parameter-store:
    HOST: /shared/codeBuild/sonarqube/host
    PROJECT: /shared/codeBuild/sonarqube/project
  # variables:
  #   LOGIN: "squ_4a78bbf6ea2f3d2f812c7ee30a3d55f07dccf3d1"
  #   HOST: "http://audit.loyalty.cxforge.com/"
  #   Project: "aws-codepipeline"
  #   SONAR_TOKEN: "sqp_0e50bff074c760e08a7ef731630f4f642e7fb047"
phases:
  install:
    runtime-versions:
      java: corretto11
  pre_build:
    commands:
      - apt-get update
      - apt-get install unzip wget nodejs -y
      - export SONAR_SCANNER_VERSION=4.7.0.2747
      - export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
      - curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip
      - unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
      - export PATH=$SONAR_SCANNER_HOME/bin:$PATH
      - export SONAR_SCANNER_OPTS="-server"

  build:
    commands:
      - sonar-scanner -Dsonar.projectKey=$PROJECT -Dsonar.sources=. -Dsonar.host.url=$HOST
      # - wget https://ufpr.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.4.0/zabbix-4.4.0.tar.gz
      # - tar -zxvf zabbix-4.4.0.tar.gz
      # - cd zabbix-4.4.0
      # - sonar-scanner -X -Dsonar.projectKey=aws-codepipeline -Dsonar.sources=. -Dsonar.host.url=http://audit.loyalty.cxforge.com -Dsonar.login=sqp_0e50bff074c760e08a7ef731630f4f642e7fb047
      # - mvn test     
      # - mvn sonar:sonar -Dsonar.login=$LOGIN -Dsonar.host.url=$HOST -Dsonar.projectKey=$Project
      # - sleep 5
      # - curl https://sonarcloud.io/api/qualitygates/project_status?projectKey=$Project >result.json
      # - cat result.json
      # - if [ $(jq -r '.projectStatus.status' result.json) = ERROR ] ; then $CODEBUILD_BUILD_SUCCEEDING -eq 0 ;fi
